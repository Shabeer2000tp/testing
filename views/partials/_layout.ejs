<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Sprint Sync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <%- include('../partials/_styles.ejs') %>
</head>
<body class="app-body">
    <%- include('../partials/_sidebar.ejs') %>

    <div class="main-content">
        <!-- Toast container for notifications -->
        <div aria-live="polite" aria-atomic="true" class="position-relative">
            <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
                <!-- Toasts will be appended here -->
            </div>
        </div>

        <%- include('./_messages.ejs') %>
        <%- body %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Logic for highlighting the active sidebar link
            const currentLocation = window.location.pathname;
            const menuLinks = document.querySelectorAll('.sidebar .nav-link');
            let bestMatch = null;

            menuLinks.forEach(link => {
                const linkPath = link.getAttribute('href');
                if (linkPath && currentLocation.startsWith(linkPath)) {
                    if (!bestMatch || linkPath.length > bestMatch.getAttribute('href').length) {
                        bestMatch = link;
                    }
                }
            });

            if (bestMatch) {
                menuLinks.forEach(link => link.classList.remove('active'));
                bestMatch.classList.add('active');
            }
        });
    </script>

    <% if (locals.unreadNotifications && locals.unreadNotifications.length > 0) { %>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const toastContainer = document.querySelector('.toast-container');
            const unreadNotifications = <%- JSON.stringify(locals.unreadNotifications) %>;

            if (toastContainer && unreadNotifications) {
                unreadNotifications.forEach(notification => {
                    const toastId = `toast-load-${notification._id}`;
                    const toastHTML = `
                        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                            <div class="toast-header">
                                <i class="fas fa-bell me-2"></i>
                                <strong class="me-auto">Notification</strong>
                                <small>${new Date(notification.createdAt).toLocaleTimeString()}</small>
                                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">
                                ${notification.message}
                                <div class="mt-2 pt-2 border-top">
                                    <a href="/student/notifications/${notification._id}" class="btn btn-primary btn-sm">View Details</a>
                                    <button type="button" class="btn btn-secondary btn-sm mark-as-read" data-id="${notification._id}">Mark as Read</button>
                                </div>
                            </div>
                        </div>
                    `;
                    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                    
                    const toastElement = document.getElementById(toastId);
                    const toast = new bootstrap.Toast(toastElement, { autohide: false });
                    toast.show();

                    toastElement.querySelector('.mark-as-read').addEventListener('click', function () {
                        const notificationId = this.getAttribute('data-id');
                        axios.post(`/student/notifications/${notificationId}/read`)
                            .then(response => {
                                if (response.data.success) {
                                    toast.hide();
                                }
                            })
                            .catch(error => {
                                console.error('Error marking notification as read:', error);
                            });
                    });
                });
            }
        });
    </script>
    <% } %>

    <% if (user) { %>
    <script>
        // Real-time notification logic via Socket.IO
        const socket = io();
        socket.on('new_notification', (notification) => {
            const toastContainer = document.querySelector('.toast-container');
            if (toastContainer) {
                const toastId = `toast-realtime-${notification._id}`;
                const toastHTML = `
                    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                        <div class="toast-header">
                            <i class="fas fa-bell me-2"></i>
                            <strong class="me-auto">New Notification</strong>
                            <small>Just now</small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            ${notification.message}
                            <div class="mt-2 pt-2 border-top">
                                <a href="/student/notifications/${notification._id}" class="btn btn-primary btn-sm">View Details</a>
                                <button type="button" class="btn btn-secondary btn-sm mark-as-read" data-id="${notification._id}">Mark as Read</button>
                            </div>
                        </div>
                    </div>
                `;
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { autohide: false });
                toast.show();

                toastElement.querySelector('.mark-as-read').addEventListener('click', function () {
                    const notificationId = this.getAttribute('data-id');
                    axios.post(`/student/notifications/${notificationId}/read`)
                        .then(response => {
                            if (response.data.success) {
                                toast.hide();
                            }
                        })
                        .catch(error => {
                            console.error('Error marking notification as read:', error);
                        });
                });
            }
        });
    </script>
    <% } %>
</body>
</html>