<%- include('../partials/_header.ejs', { title: title, user: user, sprintSetting: sprintSetting }) %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>All Teams</h1>
    <a href="/admin/teams/new" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Create Team</a>
</div>

<%- include('../partials/_messages.ejs') %>

<div class="card mb-4">
    <div class="card-body">
        <form action="/admin/teams" method="GET" class="row g-3">
            <div class="col-md-3">
                <input type="text" name="search" class="form-control" placeholder="Search teams..." value="<%= search %>">
            </div>
            <div class="col-md-3">
                <select name="sortBy" class="form-select" onchange="this.form.submit()">
                    <option value="name" <%= sortBy === 'name' ? 'selected' : '' %>>Sort by Name</option>
                    <option value="sprint_progress" <%= sortBy === 'sprint_progress' ? 'selected' : '' %>>Sort by Sprint Progress</option>
                    <option value="overall_progress" <%= sortBy === 'overall_progress' ? 'selected' : '' %>>Sort by Overall Progress</option>
                    <option value="domain" <%= sortBy === 'domain' ? 'selected' : '' %>>Sort by Domain</option>
                </select>
            </div>
            <div class="col-md-3">
                <select name="filter" class="form-select" onchange="this.form.submit()">
                    <option value="">All Projects</option>
                    <option value="atRisk" <%= filter === 'atRisk' ? 'selected' : '' %>>At Risk Only</option>
                    <option value="archived" <%= filter === 'archived' ? 'selected' : '' %>>Archived Teams</option>
                </select>
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button type="submit" class="btn btn-secondary flex-grow-1">Search</button>
                <% if (search || filter || (sortBy && sortBy !== 'name')) { %>
                    <a href="/admin/teams" class="btn btn-outline-secondary">Clear</a>
                <% } %>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Team Name</th>
                        <th>Project / Domain</th>
                        <th>Guide</th>
                        <th>Active Sprint</th>
                        <th>Progress</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (teams.length > 0) { %>
                        <% teams.forEach(team => { %>
                            <tr>
                                <td>
                                    <strong><%= team.name %></strong>
                                    <% if (team.isAtRisk) { %>
                                        <span class="badge bg-danger ms-2">At Risk</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="small"><%= team.projectTitle %></div>
                                    <span class="badge bg-light text-dark border"><%= team.domainName %></span>
                                </td>
                                <td><%= team.guide ? team.guide.name : 'Unassigned' %></td>
                                <td><%= team.activeSprintName || 'None' %></td>
                                <td style="width: 200px;">
                                    <% if (team.activeSprintName) { %>
                                        <% if (team.sprintTotalPoints > 0) { %>
                                            <% 
                                                const percentage = (team.completedStoryPoints / team.sprintTotalPoints) * 100;
                                                let progressClass = 'bg-success';
                                                if (percentage < 40) progressClass = 'bg-danger';
                                                else if (percentage < 80) progressClass = 'bg-warning';
                                            %>
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar <%= progressClass %>" role="progressbar" style="width: <%= percentage %>%;" title="<%= percentage.toFixed(1) %>%"></div>
                                            </div>
                                            <small class="text-dark"><%= team.completedStoryPoints %> / <%= team.sprintTotalPoints %> HR</small>
                                        <% } else { %>
                                            <small class="text-dark">0 HR Planned</small>
                                        <% } %>
                                    <% } else { %>
                                        <span class="text-dark small">No active sprint</span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (team.isAtRisk) { %>
                                        <span class="text-danger"><i class="fas fa-exclamation-circle"></i> Attention Needed</span>
                                    <% } else if (team.isUnscheduled) { %>
                                        <span class="text-secondary">Unscheduled</span>
                                    <% } else { %>
                                        <span class="text-success">On Track</span>
                                    <% } %>
                                </td>
                                <td>
                                    <a href="/admin/teams/<%= team._id %>" class="btn btn-sm btn-info text-white"><i class="fas fa-eye"></i></a>
                                    <a href="/admin/teams/<%= team._id %>/edit" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></a>
                                    <% if (filter === 'archived') { %>
                                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#actionTeamModal" data-team-id="<%= team._id %>" data-team-name="<%= team.name %>" data-action="restore">
                                            <i class="fas fa-trash-restore"></i>
                                        </button>
                                    <% } else { %>
                                        <button type="button" class="btn btn-sm btn-warning text-dark" data-bs-toggle="modal" data-bs-target="#actionTeamModal" data-team-id="<%= team._id %>" data-team-name="<%= team.name %>" data-action="archive">
                                            <i class="fas fa-archive"></i>
                                        </button>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" class="text-center py-4">No teams found.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<% if (totalPages > 1) { %>
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                <a class="page-link" href="/admin/teams?page=<%= currentPage - 1 %>&search=<%= search %>&sortBy=<%= sortBy %>&filter=<%= filter %>">Previous</a>
            </li>
            <% for(let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                    <a class="page-link" href="/admin/teams?page=<%= i %>&search=<%= search %>&sortBy=<%= sortBy %>&filter=<%= filter %>"><%= i %></a>
                </li>
            <% } %>
            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="/admin/teams?page=<%= currentPage + 1 %>&search=<%= search %>&sortBy=<%= sortBy %>&filter=<%= filter %>">Next</a>
            </li>
        </ul>
    </nav>
<% } %>

<!-- Archive/Restore Confirmation Modal -->
<div class="modal fade" id="actionTeamModal" tabindex="-1" aria-labelledby="actionTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionTeamModalLabel">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to <span id="actionText"></span> the team <strong id="teamNameToAction"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="actionTeamForm" method="POST">
                    <button type="submit" class="btn" id="actionButton">Confirm</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const actionModal = document.getElementById('actionTeamModal');
        if (actionModal) {
            actionModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const teamId = button.getAttribute('data-team-id');
                const teamName = button.getAttribute('data-team-name');
                const action = button.getAttribute('data-action');

                const teamNameSpan = actionModal.querySelector('#teamNameToAction');
                const actionTextSpan = actionModal.querySelector('#actionText');
                const actionForm = actionModal.querySelector('#actionTeamForm');
                const actionButton = actionModal.querySelector('#actionButton');

                teamNameSpan.textContent = teamName;
                
                if (action === 'restore') {
                    actionTextSpan.textContent = 'restore';
                    actionForm.action = `/admin/teams/${teamId}/delete?restore=true`;
                    actionButton.className = 'btn btn-success';
                } else {
                    actionTextSpan.textContent = 'archive';
                    actionForm.action = `/admin/teams/${teamId}/delete`;
                    actionButton.className = 'btn btn-warning';
                }
            });
        }
    });
</script>

<%- include('../partials/_footer.ejs') %>