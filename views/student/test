<!-- <!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Student Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>

        body { font-family: sans-serif; padding: 2rem; }

        .container { display: flex; flex-wrap: wrap; gap: 2rem; }

        .main-content { flex: 2; min-width: 300px; }

        .sidebar { flex: 1; min-width: 250px; }

        .card { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }

        h1, h2, h3, h4 { border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }

        .nav-links { margin-bottom: 1.5rem; }

        .nav-links a { margin-right: 1rem; text-decoration: none; color: #007bff; }

        form div { margin-bottom: 1rem; }

        input, textarea, select { width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }

        th, td { border: 1px solid #ddd; padding: 8px; }

        .progress-bar { width: 100%; background-color: #e9ecef; border-radius: .25rem; }

        .progress-bar-inner { height: 20px; background-color: #28a745; border-radius: .25rem; text-align: center; color: white; line-height: 20px;}

    </style>

</head>

<body>

    <h1>Student Dashboard</h1>

    <div class="nav-links">

        <a href="/student/proposal">View Proposal</a> |

        <a href="/student/backlog">Project Backlog</a> |

        <a href="/student/sprint-planning">Sprint Planning</a> |

        <a href="/student/daily-log">Daily Log</a> |

        <a href="/student/upload">Upload Deliverable</a>

        <a href="/student/past-sprints">Past</a>

    </div>

    <div class="card">

    <h3>Overall Project Progress</h3>

    <p><%= overallCompletedPoints %> / <%= overallTotalPoints %> Total Story Points Completed</p>

    <div class="progress-bar">

        <div class="progress-bar-inner" style="width: <%= (overallCompletedPoints / (overallTotalPoints || 1)) * 100 %>%">

            <%= Math.round((overallCompletedPoints / (overallTotalPoints || 1)) * 100) %>%

        </div>

    </div>

</div>



<% if (activeSprint && team) { %>

    <% } %>



    <%- include('../partials/_messages.ejs') %>



    <% if (activeSprint && team) { %>

        <div class="container">

            <div class="main-content">

                <div class="card">

                    <h3>Current Tasks for Team: <%= team.name %></h3>

                    <table>

                        <thead>

                            <tr>

                                <th>Task Description</th>

                                <th>Assigned To</th>

                                <th>Story Points</th>

                                <th>Status</th>

                            </tr>

                        </thead>

                        <tbody>

                            <% teamTasks.forEach(task => { %>

                                <tr>

                                    <td><%= task.description %></td>

                                    <td><%= task.assignedTo.name %></td>

                                    <td><%= task.storyPoints %></td>

                                    <td>

                                        <form action="/student/tasks/<%= task._id %>/status" method="POST">

                                            <select name="status" onchange="this.form.submit()">

                                                <option value="To-Do" <%= task.status === 'To-Do' ? 'selected' : '' %>>To-Do</option>

                                                <option value="In Progress" <%= task.status === 'In Progress' ? 'selected' : '' %>>In Progress</option>

                                                <option value="Done" <%= task.status === 'Done' ? 'selected' : '' %>>Done</option>

                                            </select>

                                        </form>

                                        <span class="status-badge" style="background-color: <%= task.realtimeStatus.color %>;">

                                            <%= task.realtimeStatus.text %>

                                        </span>

                                    </td>

                                </tr>

                            <% }); %>

                        </tbody>

                    </table>

                </div>

                <div class="card">

                    <h3>Burndown Chart</h3>

                    <canvas id="burndownChart"></canvas>

                </div>

                <div class="card">

                    <h3>Team Deliverables</h3>

                    <% if (deliverables.length > 0) { %>

                        <table>

                            <thead>

                                <tr>

                                    <th>File Name</th>

                                    <th>Uploaded By</th>

                                    <th>Date</th>

                                    <th>Action</th>

                                </tr>

                            </thead>

                            <tbody>

                                <% deliverables.forEach(deliverable => { %>

                                    <tr>

                                        <td><%= deliverable.fileName %></td>

                                        <td><%= deliverable.uploadedBy.name %></td>

                                        <td><%= new Date(deliverable.createdAt).toLocaleDateString() %></td>

                                        <td>

                                            <a href="/deliverables/download/<%= deliverable._id %>" class="action-link">Download</a>

                                        </td>

                                    </tr>

                                <% }); %>

                            </tbody>

                        </table>

                    <% } else { %>

                        <p>No deliverables have been uploaded by your team yet.</p>

                    <% } %>

                </div>

            </div>

            <div class="sidebar">

                <div class="card">

                    <h3>Sprint: <%= activeSprint.name %></h3>

                    <p><strong>Goal:</strong> <%= activeSprint.goal %></p>

                    <p><strong>Ends on:</strong> <%= new Date(activeSprint.endDate).toLocaleDateString() %></p>

                    <hr>

                    <h4>Team Progress</h4>

                    <p><%= completedStoryPoints %> / <%= totalStoryPoints %> Story Points Completed</p>

                    <div class="progress-bar">

                        <div class="progress-bar-inner" style="width: <%= (completedStoryPoints / (totalStoryPoints || 1)) * 100 %>%">

                            <%= Math.round((completedStoryPoints / (totalStoryPoints || 1)) * 100) %>%

                        </div>

                    </div>

                </div>

                <div class="card">

                    <h3>Add New Task</h3>

                    <form action="/student/tasks" method="POST">

                        <input type="hidden" name="sprintId" value="<%= activeSprint._id %>">

                        <input type="hidden" name="teamId" value="<%= team._id %>">

                        <div>

                            <label for="description">Task Description</label>

                            <textarea id="description" name="description" rows="3" required></textarea>

                        </div>

                        <div>

                            <label for="storyPoints">Story Points</label>

                            <input type="number" id="storyPoints" name="storyPoints" min="1" required>

                        </div>

                        <button type="submit">Add Task</button>

                    </form>

                </div>

            </div>

        </div>

    <% } else { %>

        <p>There is no active sprint, or you have not been assigned to a team yet.</p>

    <% } %>



    <form action="/logout" method="POST" style="margin-top: 2rem;">

        <button type="submit">Logout</button>

    </form>



    <script>

        document.addEventListener('DOMContentLoaded', function() {

            <% if (burndownChartData) { %>

                const ctx = document.getElementById('burndownChart');

                if (ctx) {

                    new Chart(ctx, {

                        type: 'line',

                        data: {

                            labels: <%- burndownChartData.labels %>,

                            datasets: [{

                                label: 'Remaining Work',

                                data: <%- burndownChartData.actualData %>,

                                borderColor: 'rgb(75, 192, 192)',

                                tension: 0.1,

                                fill: false

                            }, {

                                label: 'Ideal Pace',

                                data: <%- burndownChartData.idealData %>,

                                borderColor: 'rgb(255, 99, 132)',

                                borderDash: [5, 5],

                                fill: false

                            }]

                        },

                        options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Story Points Remaining' } } } }

                    });

                }

            <% } %>

        });

    </script>

</body>

</html> -->

<!DOCTYPE html>

<html lang="en">

    <%- include('../partials/_header.ejs', { title: title }) %>

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Student Dashboard - Sprint Sync</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>

        :root {

            --primary: #4e73df;

            --primary-dark: #3a56c4;

            --secondary: #858796;

            --success: #1cc88a;

            --info: #36b9cc;

            --warning: #f6c23e;

            --danger: #e74a3b;

            --light: #f8f9fc;

            --dark: #5a5c69;

            --sidebar-width: 250px;

        }

       

        body {

            background-color: #f8f9fc;

            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;

            margin: 0;

            padding: 0;

            display: flex;

            min-height: 100vh;

        }

       

        /* Sidebar Navigation */

     

       

        .sidebar-header {

            padding: 1.5rem 1rem;

            text-align: center;

            border-bottom: 1px solid rgba(255, 255, 255, 0.1);

        }

       

        .sidebar-header h3 {

            font-weight: 700;

            font-size: 1.4rem;

            margin-top: 0.5rem;

        }

       

        .sidebar-menu {

            padding: 1rem 0;

        }

       

        .menu-item {

            padding: 0.85rem 1.5rem;

            display: flex;

            align-items: center;

            color: rgba(255, 255, 255, 0.9);

            text-decoration: none;

            transition: all 0.3s;

            font-weight: 500;

        }

       

        .menu-item:hover, .menu-item.active {

            background-color: rgba(255, 255, 255, 0.1);

            color: white;

            border-left: 4px solid white;

        }

       

        .menu-item i {

            margin-right: 0.75rem;

            font-size: 1.1rem;

            width: 20px;

            text-align: center;

        }

       

        .user-info-sidebar {

            padding: 1rem 1.5rem;

            border-top: 1px solid rgba(255, 255, 255, 0.1);

            margin-top: auto;

        }

       

        .user-avatar-sidebar {

            width: 40px;

            height: 40px;

            border-radius: 50%;

            background-color: rgba(255, 255, 255, 0.2);

            display: flex;

            align-items: center;

            justify-content: center;

            color: white;

            font-weight: 600;

            margin-right: 0.75rem;

        }

       

        /* Main Content */

        .main-content {

            flex: 1;

            margin-left: var(--sidebar-width);

            padding: 2rem;

            min-height: 100vh;

        }

       

        .welcome-header {

            margin-bottom: 2rem;

        }

       

        .welcome-header h1 {

            color: var(--dark);

            font-weight: 700;

            margin-bottom: 0.25rem;

        }

       

        .welcome-header p {

            color: var(--secondary);

            margin-bottom: 0;

        }

       

        .card {

            border: none;

            border-radius: 0.5rem;

            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);

            margin-bottom: 1.5rem;

            transition: transform 0.3s;

        }

       

        .card:hover {

            transform: translateY(-5px);

        }

       

        .card-header {

            background-color: white;

            border-bottom: 1px solid #e3e6f0;

            padding: 1rem 1.5rem;

            font-weight: 700;

            color: var(--dark);

            border-radius: 0.5rem 0.5rem 0 0 !important;

        }

       

        .card-body {

            padding: 1.5rem;

        }

       

        .progress {

            height: 20px;

            border-radius: 0.35rem;

            margin-bottom: 0.5rem;

        }

       

        .progress-bar {

            border-radius: 0.35rem;

            font-weight: 600;

            font-size: 0.75rem;

            display: flex;

            align-items: center;

            justify-content: center;

        }

       

        .table th {

            background-color: #f8f9fc;

            border-bottom: 1px solid #e3e6f0;

            font-weight: 700;

            color: var(--dark);

            padding: 0.75rem 1.5rem;

        }

       

        .table td {

            padding: 1rem 1.5rem;

            vertical-align: middle;

        }

       

        .status-badge {

            padding: 0.25rem 0.5rem;

            border-radius: 0.35rem;

            font-size: 0.75rem;

            font-weight: 700;

            margin-left: 0.5rem;

        }

       

        .chart-container {

            position: relative;

            height: 300px;

            margin: 1.5rem 0;

        }

       

        .action-link {

            color: var(--primary);

            text-decoration: none;

            font-weight: 600;

        }

       

        .action-link:hover {

            color: #224abe;

            text-decoration: underline;

        }

       

        .empty-state {

            text-align: center;

            padding: 2rem 1rem;

            color: var(--secondary);

        }

       

        .empty-state i {

            font-size: 3rem;

            margin-bottom: 1rem;

            color: #dddfeb;

        }

       

        .empty-state p {

            font-size: 1.1rem;

            margin-bottom: 0;

        }

       

        .user-info-main {

            display: flex;

            align-items: center;

            background: white;

            padding: 0.75rem 1rem;

            border-radius: 0.5rem;

            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);

            margin-bottom: 1.5rem;

        }

       

        .user-avatar-main {

            width: 40px;

            height: 40px;

            border-radius: 50%;

            background-color: var(--primary);

            display: flex;

            align-items: center;

            justify-content: center;

            color: white;

            font-weight: 600;

            margin-right: 0.75rem;

        }

       

        .user-details .user-name {

            font-weight: 600;

            margin-bottom: 0;

            line-height: 1.2;

        }

       

        .user-details .user-role {

            font-size: 0.8rem;

            color: var(--secondary);

        }

       

        @media (max-width: 768px) {

            .sidebar {

                width: 80px;

            }

           

            .sidebar-header h3, .menu-item span {

                display: none;

            }

           

            .menu-item {

                justify-content: center;

                padding: 1rem;

            }

           

            .menu-item i {

                margin-right: 0;

                font-size: 1.3rem;

            }

           

            .user-info-sidebar {

                display: none;

            }

           

            .main-content {

                margin-left: 80px;

            }

           

            .table th, .table td {

                padding: 0.75rem;

            }

        }

    </style>

</head>

<body>

              <div class="user-info-sidebar">

            <div class="d-flex align-items-center">

                <div class="user-avatar-sidebar">

                    <%

                    const userName = user && user.name ? user.name : 'Student';

                    const firstChar = userName.charAt(0);

                    %>

                    <%= firstChar %>

                </div>

                <div>

                    <div class="text-white"><%= userName %></div>

                    <div class="text-white-50 small">Student</div>

                </div>

            </div>

            <form action="/logout" method="POST" class="mt-3">

                <button type="submit" class="btn btn-sm btn-outline-light w-100">

                    <i class="fas fa-sign-out-alt me-1"></i> Logout

                </button>

            </form>

        </div>

    </div>



    <!-- Main Content -->

    <div class="main-content">

        <div class="welcome-header">

            <h1>Student Dashboard</h1>

            <p>Welcome to your project management dashboard</p>

        </div>

       

        <%- include('../partials/_messages.ejs') %>

       

        <!-- User Info -->

        <div class="user-info-main">

            <div class="user-avatar-main">

                <%= firstChar %>

            </div>

            <div class="user-details">

                <div class="user-name"><%= userName %></div>

                <div class="user-role">Student</div>

            </div>

        </div>

       

        <!-- Overall Progress Card -->

<% if (sprintSetting && sprintSetting.value === 'global') { %>

        <div class="card">

            <div class="card-header">

                <i class="fas fa-chart-line me-2"></i> Overall Project Progress

            </div>

            <div class="card-body">

                <p class="card-text">

                    <%= overallCompletedPoints %> / <%= overallTotalPoints %> Total Story Points Completed

                </p>

                <div class="progress">

                    <div class="progress-bar bg-success" role="progressbar"

                         style="width: <%= (overallCompletedPoints / (overallTotalPoints || 1)) * 100 %>%">

                        <%= Math.round((overallCompletedPoints / (overallTotalPoints || 1)) * 100) %>%

                    </div>

                </div>

            </div>

        </div>

    <% } else { %>

        <div class="card">

            <div class="card-header">

                <i class="fas fa-users me-2"></i> Team Project Progress

            </div>

            <div class="card-body">

                <p class="card-text">

                    <%= overallCompletedPoints %> / <%= teamTotalPlannedPoints %> Total Story Points Completed

                </p>

                <div class="progress">

                    <div class="progress-bar bg-primary" role="progressbar"

                         style="width: <%= (overallCompletedPoints / (teamTotalPlannedPoints || 1)) * 100 %>%">

                        <%= Math.round((overallCompletedPoints / (teamTotalPlannedPoints || 1)) * 100) %>%

                    </div>

                </div>

            </div>

        </div>

    <% } %>

       

        <% if (activeSprint && team) { %>

            <div class="row">

                <!-- Left Column -->

                <div class="col-lg-8">

                    <!-- Current Tasks -->

                    <div class="card">

                        <div class="card-header">

                            <i class="fas fa-tasks me-2"></i> Current Tasks for Team: <%= team.name %>

                        </div>

                        <div class="card-body">

                            <% if (teamTasks.length > 0) { %>

                                <div class="table-responsive">

                                    <table class="table table-hover">

                                        <thead>

                                            <tr>

                                                <th>Task Description</th>

                                                <th>Assigned To</th>

                                                <th>Story Points</th>

                                                <th>Status</th>

                                            </tr>

                                        </thead>

                                        <tbody>

                                            <% teamTasks.forEach(task => { %>

                                                <tr>

                                                    <td><%= task.description %></td>

                                                    <td><%= task.assignedTo.name %></td>

                                                    <td><%= task.storyPoints %></td>

                                                    <td>

                                                        <form action="/student/tasks/<%= task._id %>/status" method="POST" class="d-inline">

                                                            <select name="status" class="form-select form-select-sm d-inline-block w-auto" onchange="this.form.submit()">

                                                                <option value="To-Do" <%= task.status === 'To-Do' ? 'selected' : '' %>>To-Do</option>

                                                                <option value="In Progress" <%= task.status === 'In Progress' ? 'selected' : '' %>>In Progress</option>

                                                                <option value="Done" <%= task.status === 'Done' ? 'selected' : '' %>>Done</option>

                                                            </select>

                                                        </form>

                                                        <span class="status-badge" style="background-color: <%= task.realtimeStatus.color %>; color: white;">

                                                            <%= task.realtimeStatus.text %>

                                                        </span>

                                                    </td>

                                                </tr>

                                            <% }); %>

                                        </tbody>

                                    </table>

                                </div>

                            <% } else { %>

                                <div class="empty-state">

                                    <i class="fas fa-tasks"></i>

                                    <p>No tasks assigned to your team yet.</p>

                                </div>

                            <% } %>

                        </div>

                    </div>

                   

                    <!-- Burndown Chart -->

                    <div class="card">

                        <div class="card-header">

                            <i class="fas fa-chart-line me-2"></i> Burndown Chart

                        </div>

                        <div class="card-body">

                            <div class="chart-container">

                                <canvas id="burndownChart"></canvas>

                            </div>

                        </div>

                    </div>

                   

                    <!-- Team Deliverables -->

                    <div class="card">

                        <div class="card-header">

                            <i class="fas fa-file-upload me-2"></i> Team Deliverables

                        </div>

                        <div class="card-body">

                            <% if (deliverables.length > 0) { %>

                                <div class="table-responsive">

                                    <table class="table table-hover">

                                        <thead>

                                            <tr>

                                                <th>File Name</th>

                                                <th>Uploaded By</th>

                                                <th>Date</th>

                                                <th>Action</th>

                                            </tr>

                                        </thead>

                                        <tbody>

                                            <% deliverables.forEach(deliverable => { %>

                                                <tr>

                                                    <td><%= deliverable.fileName %></td>

                                                    <td><%= deliverable.uploadedBy.name %></td>

                                                    <td><%= new Date(deliverable.createdAt).toLocaleDateString() %></td>

                                                    <td>

                                                        <a href="/deliverables/download/<%= deliverable._id %>" class="action-link">

                                                            <i class="fas fa-download me-1"></i> Download

                                                        </a>

                                                    </td>

                                                </tr>

                                            <% }); %>

                                        </tbody>

                                    </table>

                                </div>

                            <% } else { %>

                                <div class="empty-state">

                                    <i class="fas fa-file"></i>

                                    <p>No deliverables have been uploaded by your team yet.</p>

                                </div>

                            <% } %>

                        </div>

                    </div>

                </div>

               

                <!-- Right Column -->

                <div class="col-lg-4">

                    <!-- Sprint Info -->

                    <div class="card">

                        <div class="card-header">

                            <i class="fas fa-flag me-2"></i> Sprint: <%= activeSprint.name %>

                        </div>

                        <div class="card-body">

                            <p><strong>Goal:</strong> <%= activeSprint.goal %></p>

                            <p><strong>Ends on:</strong> <%= new Date(activeSprint.endDate).toLocaleDateString() %></p>

                            <hr>

                            <h5>Team Progress</h5>

                            <p><%= completedStoryPoints %> / <%= totalStoryPoints %> Story Points Completed</p>

                            <div class="progress">

                                <div class="progress-bar bg-info" role="progressbar"

                                     style="width: <%= (completedStoryPoints / (totalStoryPoints || 1)) * 100 %>%"

                                     aria-valuenow="<%= (completedStoryPoints / (totalStoryPoints || 1)) * 100 %>"

                                     aria-valuemin="0"

                                     aria-valuemax="100">

                                    <%= Math.round((completedStoryPoints / (totalStoryPoints || 1)) * 100) %>%

                                </div>

                            </div>

                        </div>

                    </div>

                   

                    <!-- Add New Task -->

                    <div class="card">

                        <div class="card-header">

                            <i class="fas fa-plus-circle me-2"></i> Add New Task

                        </div>

                        <div class="card-body">

                            <form action="/student/tasks" method="POST">

                                <input type="hidden" name="sprintId" value="<%= activeSprint._id %>">

                                <input type="hidden" name="teamId" value="<%= team._id %>">

                                <div class="mb-3">

                                    <label for="description" class="form-label">Task Description</label>

                                    <textarea class="form-control" id="description" name="description" rows="3" required></textarea>

                                </div>

                                <div class="mb-3">

                                    <label for="storyPoints" class="form-label">Story Points</label>

                                    <input type="number" class="form-control" id="storyPoints" name="storyPoints" min="1" required>

                                </div>

                                <button type="submit" class="btn btn-primary w-100">

                                    <i class="fas fa-plus me-2"></i> Add Task

                                </button>

                            </form>

                        </div>

                    </div>

                </div>

            </div>

        <% } else { %>

            <div class="card">

                <div class="card-body">

                    <div class="empty-state">

                        <i class="fas fa-info-circle"></i>

                        <p>There is no active sprint, or you have not been assigned to a team yet.</p>

                    </div>

                </div>

            </div>

        <% } %>

    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        document.addEventListener('DOMContentLoaded', function() {

            <% if (burndownChartData) { %>

                const ctx = document.getElementById('burndownChart');

                if (ctx) {

                    new Chart(ctx, {

                        type: 'line',

                        data: {

                            labels: <%- burndownChartData.labels %>,

                            datasets: [{

                                label: 'Remaining Work',

                                data: <%- burndownChartData.actualData %>,

                                borderColor: 'rgb(75, 192, 192)',

                                tension: 0.1,

                                fill: false

                            }, {

                                label: 'Ideal Pace',

                                data: <%- burndownChartData.idealData %>,

                                borderColor: 'rgb(255, 99, 132)',

                                borderDash: [5, 5],

                                fill: false

                            }]

                        },

                        options: {

                            responsive: true,

                            maintainAspectRatio: false,

                            scales: {

                                y: {

                                    beginAtZero: true,

                                    title: {

                                        display: true,

                                        text: 'Story Points Remaining'

                                    }

                                }

                            }

                        }

                    });

                }

            <% } %>

           

            // Add active class to current menu item

            const currentLocation = window.location.pathname;

            const menuItems = document.querySelectorAll('.menu-item');

           

            menuItems.forEach(item => {

                if (item.getAttribute('href') === currentLocation) {

                    item.classList.add('active');

                } else {

                    item.classList.remove('active');

                }

            });

        });

    </script>

</body>

</html> 



// // exports.getDashboard = async (req, res) => {
//     try {
//         const studentId = req.session.user.profileId;
//         const today = new Date();
//         today.setHours(0, 0, 0, 0);
//         const endOfToday = new Date();
// endOfToday.setHours(23, 59, 59, 999);

//         const team = await Team.findOne({ students: studentId });
//         const sprintSetting = await Setting.findOne({ key: 'sprintCreation' });

//         let activeSprint;
//         if (team && sprintSetting && sprintSetting.value === 'team') {
//             activeSprint = await Sprint.findOne({
//                 team: team._id,
//                 startDate: { $lte: today },
//                 endDate: { $gte: today },
//                  status: { $in: ['Active', 'Pending'] } 
//             });
//         } else {
//             activeSprint = await Sprint.findOne({
//                 team: { $exists: false },
//                 startDate: { $lte: today },
//                 endDate: { $gte: today },
//                 status: { $in: ['Active', 'Pending'] }
//             });
//         }

//         let teamTasks = [], totalStoryPoints = 0, completedStoryPoints = 0, burndownChartData = null, deliverables = [];
//         let overallTotalPoints = 0, overallCompletedPoints = 0, teamTotalPlannedPoints = 0;

//         if (team) {
//             const allSprints = await Sprint.find({});
//             overallTotalPoints = allSprints.reduce((sum, sprint) => sum + (sprint.capacity || 0), 0);
            
//             const allCompletedTasks = await Task.find({ team: team._id, status: 'Done' });
//             overallCompletedPoints = allCompletedTasks.reduce((sum, task) => sum + (task.storyPoints || 0), 0);

//             if (sprintSetting && sprintSetting.value === 'team') {
//                 const teamSprints = await Sprint.find({ team: team._id });
//                 teamTotalPlannedPoints = teamSprints.reduce((sum, sprint) => sum + (sprint.capacity || 0), 0);
//             }

//             deliverables = await Deliverable.find({ team: team._id }).populate('uploadedBy', 'name').sort({ createdAt: -1 });

//             if (activeSprint) {
//                 teamTasks = await Task.find({ team: team._id, sprint: activeSprint._id }).populate('assignedTo', 'name');
//                 teamTasks.forEach(task => {
//                     task.realtimeStatus = getTaskStatusInfo(task, activeSprint);
//                 });

//                 totalStoryPoints = teamTasks.reduce((sum, task) => sum + (task.storyPoints || 0), 0);
//                 completedStoryPoints = teamTasks.filter(task => task.status === 'Done').reduce((sum, task) => sum + (task.storyPoints || 0), 0);
                
//                 // --- BURNDOWN CHART CALCULATION BLOCK ---
//                 const sprintStartDate = new Date(activeSprint.startDate);
//                 const sprintEndDate = new Date(activeSprint.endDate);
//                 const labels = [], idealData = [], actualData = [];
//                 let remainingPoints = totalStoryPoints;
//                 const totalSprintDays = (sprintEndDate - sprintStartDate) / (1000 * 60 * 60 * 24) + 1;
//                 const idealBurnPerDay = totalStoryPoints / (totalSprintDays > 0 ? totalSprintDays : 1);

//                 for (let d = new Date(sprintStartDate); d <= sprintEndDate; d.setDate(d.getDate() + 1)) {
//                     if (d > new Date()) break;
//                     labels.push(d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
//                     const daysPassed = (d - sprintStartDate) / (1000 * 60 * 60 * 24);
//                     idealData.push(Math.round(totalStoryPoints - (daysPassed * idealBurnPerDay)));
//                     const pointsCompletedOnThisDay = teamTasks.filter(task => task.status === 'Done' && new Date(task.updatedAt).toDateString() === d.toDateString()).reduce((sum, task) => sum + (task.storyPoints || 0), 0);
//                     remainingPoints -= pointsCompletedOnThisDay;
//                     actualData.push(remainingPoints);
//                 }
//                 burndownChartData = {
//                     labels: JSON.stringify(labels),
//                     actualData: JSON.stringify(actualData),
//                     idealData: JSON.stringify(idealData),
//                 };
//                 // --- END OF CALCULATION ---
//             }
//         }
        
//         // --- If the bug persists, this log will tell us why ---
//         console.log('Data being sent to view:', { 
//             hasActiveSprint: !!activeSprint, 
//             hasBurndownData: !!burndownChartData 
//         });

//         res.render('student/dashboard', {
//             title: 'Student Dashboard',
//             user: req.session.user,
//             team,
//             activeSprint,
//             teamTasks,
//             totalStoryPoints,
//             completedStoryPoints,
//             burndownChartData, // <-- Ensure this is passed
//             deliverables,
//             overallTotalPoints,
//             overallCompletedPoints,
//             teamTotalPlannedPoints,
//             sprintSetting: sprintSetting || { value: 'global' }
//         });

//     } catch (error) {
//         console.error("Error loading student dashboard:", error);
//         req.flash('error_msg', 'Could not load your dashboard.');
//         res.redirect('/login');
//     }
// };